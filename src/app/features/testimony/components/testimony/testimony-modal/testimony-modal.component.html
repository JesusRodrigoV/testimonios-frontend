<div class="modal-content" scrollTop>
  <div class="modal-header">
    <button
      mat-icon-button
      class="close-btn"
      (click)="closeModal()"
      matTooltip="Cerrar"
      >
      <mat-icon>close</mat-icon>
    </button>
  </div>
  <div class="modal-body">
    <div class="main-content">
      <div class="media">
        @if (testimony.format === "Video") {
          <app-video-player [videoUrl]="testimony.url" />
        } @else if (testimony.format === "Audio") {
          <audio [src]="testimony.url" controls></audio>
        }
      </div>
      <h1 class="title">{{ testimony.title }}</h1>
      <div class="actions">
        <button
          mat-raised-button
          class="action-btn favorite-btn"
          (click)="addToFavorites()"
          matTooltip="Favorito"
          >
          <mat-icon>{{ isFavorite ? "favorite" : "favorite_border" }}</mat-icon>
          {{ testimony.favoriteCount }}
        </button>
        <button
          mat-icon-button
          class="action-btn share-btn"
          (click)="addToCollection()"
          matTooltip="Guardar en una colección"
          >
          <mat-icon>label</mat-icon>
        </button>
        <button
          mat-icon-button
          class="action-btn share-btn"
          (click)="shareTestimony()"
          matTooltip="Compartir"
          >
          <mat-icon>share</mat-icon>
        </button>
        @if (canDownload) {
          <button
            mat-icon-button
            class="action-btn download-btn"
            (click)="downloadTestimony()"
            matTooltip="Descargar"
            >
            <mat-icon>download</mat-icon>
          </button>
        }
        <button
          mat-icon-button
          class="action-btn suggest-btn"
          (click)="suggestImprovement()"
          matTooltip="Sugerir mejora"
          >
          <mat-icon>edit</mat-icon>
        </button>
      </div>
      <div class="meta">
        <div class="meta-header">
          <p class="meta-author">Subido por: {{ testimony.author }}</p>
          <p class="meta-date">{{ getRelativeTime(testimony.createdAt) }}</p>
          <button
            mat-icon-button
            (click)="toggleMeta()"
            class="meta-toggle-btn"
            matTooltip="{{ isMetaExpanded ? 'Mostrar menos' : 'Mostrar más' }}"
            >
            <mat-icon>{{ isMetaExpanded ? "expand_less" : "expand_more" }}</mat-icon>
          </button>
        </div>
        <div class="meta-details" [ngClass]="{ expanded: isMetaExpanded }">
          <p>Fecha: {{ testimony.createdAt | date: "medium" }}</p>
          <p>Categorías: {{ testimony.categories.join(", ") || "Ninguna" }}</p>
          <p>Etiquetas: {{ testimony.tags.join(", ") || "Ninguna" }}</p>
          @if (testimony.event) {
            <p>Evento: {{ testimony.event }}</p>
          }
        </div>
      </div>
      <div class="description-section">
        <div class="description-header">
          <p>Descripción</p>
          <button
            mat-icon-button
            (click)="toggleDescription()"
            class="description-toggle-btn"
            matTooltip="{{ isDescriptionExpanded ? 'Mostrar menos' : 'Mostrar más' }}"
            >
            <mat-icon>{{ isDescriptionExpanded ? "expand_less" : "expand_more" }}</mat-icon>
          </button>
        </div>
        <div
          class="description-content"
          [ngClass]="{ expanded: isDescriptionExpanded }"
          >
          <p>{{ testimony.description || "Sin descripción disponible." }}</p>
        </div>
      </div>
      @if (testimony.format !== 'Texto') {
        <div class="transcription">
          <div class="transcription-header">
            <p>Transcripción</p>
            <button
              mat-icon-button
              (click)="toggleTranscription()"
              class="transcription-toggle-btn"
              matTooltip="{{ isTranscriptionExpanded ? 'Mostrar menos' : 'Mostrar más' }}"
              >
              <mat-icon>{{ isTranscriptionExpanded ? "expand_less" : "expand_more" }}</mat-icon>
            </button>
          </div>
          <div
            class="transcription-content"
            [ngClass]="{ expanded: isTranscriptionExpanded }"
            >
            @if (transcripciones.length > 0) {
              <div class="transcription-text">
                @for (transcripcion of transcripciones; track transcripcion.id_transcripcion) {
                  <div class="transcription-item">
                    <p>{{ transcripcion.contenido }}</p>
                    <p class="transcription-meta">
                      Idioma: {{ transcripcion.idioma }} |
                      Creado: {{ transcripcion.fecha_creacion | date: 'short' }} |
                      Por: {{ transcripcion.usuarios?.nombre || 'Desconocido' }}
                    </p>
                  </div>
                }
              </div>
            } @else if (canRequestTranscription) {
              <div class="transcription-empty">
                <p>No hay transcripciones disponibles.</p>
                <button
                  mat-raised-button
                  color="accent"
                  (click)="requestTranscription()"
                  >
                  Solicitar Transcripción
                </button>
              </div>
            } @else {
              <p>No hay transcripciones disponibles. Inicia sesión para solicitar una.</p>
            }
          </div>
        </div>
      }
      <section class="rating-container">
        <h3 class="rating-title">Calificar este testimonio</h3>
        @if (currentRating > 0 && !isRatingLoading) {
          <p class="rating-status">
            Tu calificación: {{ currentRating }} estrella{{ currentRating === 1 ? '' : 's' }}
          </p>
        }
        <div class="rating" [ngClass]="{ loading: isRatingLoading }">
          @for (star of [5, 4, 3, 2, 1]; track star) {
            <ng-container>
              <input
                type="radio"
                [id]="'star-' + star"
                name="star-radio"
                [value]="star"
                [(ngModel)]="currentRating"
                (change)="rateTestimony(star)"
                [disabled]="!authStore.isAuthenticated() || isRatingLoading"
                />
                <label [for]="'star-' + star">
                  <i
                    class="bx"
                    [ngClass]="star <= currentRating ? 'bxs-star' : 'bx-star'"
                  ></i>
                </label>
              </ng-container>
            }
          </div>
          @if (!authStore.isAuthenticated()) {
            <p class="rating-login">
              Inicia sesión para calificar este testimonio.
            </p>
          }
        </section>
      </div>
      <div class="comments-sidebar">
        <app-testimony-comments
          [testimonyId]="testimony.id"
        ></app-testimony-comments>
      </div>
    </div>
  </div>